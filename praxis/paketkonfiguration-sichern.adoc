// Datei: ./praxis/paketkonfiguration-sichern.adoc

// Baustelle: Notizen

[[paketkonfiguration-sichern]]
== Paketkonfiguration sichern ==

// Stichworte für den Index
(((debconf-get-selections)))
(((debconf-set-selections)))
(((Debianpaket, apt-clone)))
(((Debianpaket, debconf)))
(((Debianpaket, debconf-utils)))
(((Debianpaket, dpkg)))
(((Paketkonfiguration, Klonen einer bestehenden Installation)))
(((Paketkonfiguration, bestehende Installation sichern)))
(((Paketkonfiguration, debconf-get-selections)))
(((Paketkonfiguration, debconf-set-selections)))
(((Paketkonfiguration, gesicherte Konfiguration wieder einspielen)))
(((Paketliste verstehen)))

Betreuen Sie eine Reihe von Rechnern, die jeweils aktuell und identisch 
bleiben müssen, ist das manuelle Sichern, Pflegen und Einspielen einer 
Paketliste etwas mühselig. Der händische Abgleich mit Hilfe von `dpkg` und 
`diff` braucht einfach zu lange, ist zudem fehleranfällig und hält Sie von 
weitaus spannenderen Aufgaben ab. 

Daher betrachten wir in diesem Kapitel verschiedene Wege, um diesen Schritt 
möglichst zu automatisieren. Zum Einsatz kommen die Werkzeuge `dpkg` (siehe
<<paketkonfiguration-sichern-mit-dpkg>>), `debconf-get-selections` (siehe
<<paketkonfiguration-sichern-mit-debconf-get-selections>>), 
`debconf-set-selections` und `apt-clone` (siehe 
<<paketkonfiguration-sichern-mit-apt-clone>>). 

[[paketkonfiguration-auslesen]]
=== Die bestehende Paketkonfiguration auslesen ===

// Stichworte für den Index
(((Paketkonfiguration, auslesen)))
Zunächst gehen wir der Frage nach, wie Sie die bestehende Konfiguration
ihrer installierten Pakete auslesen und sichern. Das nutzen Sie in einem 
späteren Schritt, um diese Pakete wieder einspielen zu können -- sei es auf 
dem gleichen System oder einem neuen Rechner, welcher identisch zum 
erstgenannten werden muss. Alle benötigten Informationen dazu stehen in der 
Debconf-Datenbank.

[[paketkonfiguration-sichern-mit-dpkg]]
==== Mit `dpkg` ====

// Stichworte für den Index
(((debconf-get-selections)))
(((Debianpaket, debconf)))
(((Debianpaket, dpkg)))

Zu nutze machen wir uns die Beispiele zum Filtern der bereits auf dem System 
installierten Pakete aus dem Abschnitt <<liste-der-installierten-pakete-anzeigen-und-deuten>>. 

* `dpkg -l | egrep '^ii' > paketliste`

[[paketkonfiguration-sichern-mit-debconf-get-selections]]
==== Mit `debconf-get-selections` ====

// Stichworte für den Index
(((debconf-get-selections)))
(((Debianpaket, debconf-utils)))
Zum Auslesen nutzen Sie das Werkzeug `debconf-get-selections` aus dem Paket 
'debconf-utils' <<Debian-Paket-debconf-utils>>. Ausführlicher ist der Vorgang 
bereits unter 'Konfiguration für alle Pakete auslesen' in 
<<konfiguration-fuer-alle-pakete-auslesen>> beschrieben.

Die Ausgabe von `debconf-get-selections` erfolgt auf der Standardausgabe
(`stdout`) und ist nachfolgend als Ausschnitt dargestellt.

.Auslesen der bestehenden Paketkonfiguration aus der Debconf-Datenbank (Ausschnitt)
----
# debconf-get-selections
...
# Nicht zugestellte E-Mails im »spool«-Verzeichnis löschen?
exim4-base	exim4/purge_spool	boolean	false
# Soll smb.conf automatisch konfiguriert werden?
samba-common	samba-common/do_debconf	boolean	true
# Schriftgröße:
# Choices: 
console-setup	console-setup/fontsize-text47	select	8x16
...
#
----

[[paketkonfiguration-sichern-mit-apt-clone]]
==== Mit `apt-clone` ====

// Stichworte für den Index
(((apt-clone)))
(((apt-clone, clone)))
(((apt-clone, info)))
(((Debianpaket, apt-clone)))
(((Debianpaket, dpkg-repack)))
(((Ubuntupaket, apt-clone)))

Dieses Werkzeug steht über die gleichnamigen Pakete bei Debian und Ubuntu 
bereit (siehe <<Debian-Paket-apt-clone>> und <<Ubuntu-Paket-apt-clone>>).
Es sieht sich selbst als 'helper script', welches das Klonen einer bestehenden
Linuxinstallation vereinfacht. 

Es stellt daher nach Möglichkeit auf dem Bestandssystem so viele 
Informationen zur Installation zusammen, wie möglich sind. Das umfasst neben 
der Datei `/etc/apt/sources.list` den Debian-Schlüsselring mit den darin 
hinterlegten GPG-Schlüsseln für die verwendeten Paketquellen sowie auch den 
Paketstatus. Ergebnis der Ausführung ist ein Archiv im Format `tar.gz`, welches
Sie auf dem Zielsystem einspielen.

Das erzeugte Archiv beinhaltet auch die Pakete, die nicht mehr von den 
Paketquellen heruntergeladen werden können. Dazu bedient sich `apt-clone` des 
Werkzeugs `dpkg-repack` <<Debian-Paket-dpkg-repack>>, welches aus den bereits
installierten Dateien wieder Binärpakete erstellt, sofern das möglich ist. Im 
nachfolgenden Beispiel sehen Sie, dass das nicht immer gelingt und auch zu
Paketen führen kann, die defekt sind (`broken`) und nicht sauber 
wiedereinspielbar sind.

Bevor Sie `apt-clone` ausführen, legen Sie ein Verzeichnis fest, in dem das 
Archiv abgelegt werden soll. Im nachfolgenden Beispiel heißt das Verzeichnis 
schlicht und einfach `packagelist`.

.`apt-clone` sammelt Informationen
----
# apt-clone clone --with-dpkg-repack packagelist/.
dpkg-deb: building package 'sge' in './sge_8.1.8_amd64.deb'.
dpkg-deb: building package 'libnccl2' in './libnccl2_2.3.5-2+cuda10.0_amd64.deb'.
dpkg-repack: warning: unknown information field 'Original-Maintainer' in input data in entry in dpkg's status file
dpkg-deb: building package 'lesstif2' in './lesstif2_0.95.2-1_amd64.deb'.
dpkg-repack: warning: unknown information field 'Original-Maintainer' in input data in entry in dpkg's status file
dpkg-deb: building package 'libcudnn7' in './libcudnn7_7.3.1.20-1+cuda10.0_amd64.deb'.
dpkg-deb: building package 'libcudnn7-dev' in './libcudnn7-dev_7.3.1.20-1+cuda10.0_amd64.deb'.
dpkg-deb: error: conffile '/opt/sge/util/install_modules/inst_template.conf' does not appear in package
dpkg-repack: Error running: dpkg-deb --build dpkg-repack.sge-common.3EAu1a .
dpkg-repack: Problems were encountered in processing.
dpkg-repack: The package may be broken.
not installable: sge, libnccl2, lesstif2, libdb5.1, libcudnn7, libcudnn7-dev, sge-common, cuda-repo-ubuntu1804-10-0-local-10.0.130-410.48, libnccl-dev, libxp6, db5.1-util, libdb5.1++
version mismatch: libssl1.1, mdadm, python3-distutils, libitm1, libmagic-mgc, samba-libs, lxd-client, wget, postfix, cpp, 
...
# 
----

Das Archiv wird im vorgenannten Verzeichnis erzeugt. Dessen Name setzt sich aus
`apt-clone-state-` und dem Hostnamen zusammen, also bspw. 
`apt-clone-state-kiste.tar.gz`. Mit dem Schalter `info` analysieren Sie das 
soeben erzeugte Archiv:

.Informationen zum erzeugten `apt-clone`-Archiv anzeigen
----
$ apt-clone info apt-clone-state-kiste.tar.gz 
Hostname: kiste
Arch: amd64
Distro: bionic
Meta: 
Installed: 1301 pkgs (751 automatic)
Date: Tue Oct 15 14:55:03 2019
$
----

Bitte beachten Sie bei der Verwendung von `apt-clone` noch die folgenden Punkte:

* Das Zielsystem muss das gleiche Betriebssystem und die gleiche Veröffentlichung
wie das Originalsystem besitzen.

* `apt-clone` gleicht den Paketbestand des Originalsystems mit den Paketquellen 
ab. Es merkt an, wenn installierte Pakete nicht mehr aktuell sind. Um das o.g.
erzeugte Archiv möglichst klein zu halten, aktualisieren Sie das Originalsystem 
vor dem Aufruf von `apt-clone`, sofern das möglich ist (siehe 
<<pakete-aktualisieren>>).

* Führen Sie `apt-clone` später auf dem Zielsystem aus, überschreibt es ihre 
bereits bestehende Paketliste. Es löscht Pakete bzw. installiert fehlende nach
(siehe <<paketkonfiguration-wieder-einspielen-mit-apt-clone>>).

[[paketkonfiguration-einspielen]]
=== Eine gesicherte Paketkonfiguration wieder einspielen ===

// Stichworte für den Index
(((Paketkonfiguration, gesicherte Konfiguration wieder einspielen)))

[[paketkonfiguration-wieder-einspielen-mit-debconf-set-selections]]
==== Mit `debconf-set-selections` ====

// Stichworte für den Index
(((debconf-set-selections, -c)))
(((debconf-set-selections, -v)))
(((debconf-set-selections, --checkonly)))
(((debconf-set-selections, --verbose)))

* wie spiele ich das lokal wieder ein
** `debconf-set-selections` (Paket 'debconf' <<Debian-Paket-debconf>>))
** Schalter `-c` (Langformat `--checkonly`): Eingabedatei nur auf Fehler prüfen
** Schalter `-v` (Langformat `--verbose`): ausführliche Ausgabe beim Einspielen

[[paketkonfiguration-wieder-einspielen-mit-apt-clone]]
==== Mit `apt-clone` ====

// Stichworte für den Index
(((apt-clone)))
(((apt-clone, restore)))
(((apt-clone, restore-new-distro)))
(((Debianpaket, apt-clone)))
(((Ubuntupaket, apt-clone)))

Haben Sie ein Archiv wie unter <<paketkonfiguration-sichern-mit-apt-clone>> 
beschrieben erstellt, besprechen wir hier, wie Sie das auf dem Zielsystem
einspielen. Als erstes übertragen Sie das 

----
# apt-clone restore packagelist.tar.gz
...
# 
----

=== Graphische Werkzeuge ===

==== Aptik ====

// Stichworte für den Index
(((aptik)))
(((aptik-gtk)))
(((Ubuntupaket, aptik)))

Seit einigen Jahren steht Aptik für Ubuntu über die Projektseite <<aptik>> 
bereit. Bislang ist es nur nur als PPA für Ubuntu verfügbar und enthält die 
beiden Werkzeuge `aptik` und `aptik-gtk`. Letzteres ist ein graphisches 
Werkzeug zum Backup und dem Wiedereinspielen von Paketlisten, dem Paketcache 
und der installierten Software. Bislang kostenfrei, wurde inzwischen das
Vertriebsmodell geändert und die aktuelle Version ist kostenpflichtig.

==== Mintbackup ====

// Stichworte für den Index
(((mintbackup)))

Für Linux Mint steht das Werkzeug `mintbackup` bereit <<mintbackup>>. Es ist
ein graphisches Werkzeug, welches Paketlisten sichern und wieder einspielen
kann.

.Sicherungsdialog von Mintbackup
image::praxis/mintbackup.png[id="fig.mintbackup", width="50%"]

// Datei (Ende): ./praxis/paketkonfiguration-sichern.adoc
